### cryptopro CSP
### 1 Базовый Вопрос 
Есть СЭД, где подписание проводится электронной подписью.  
Параметры: 
- Тип подписи: усиленная квалифицированная электронная подпись (УКЭП).
- Выдается аккредитованным центром УЦ Контур (удостоверяющий центр). 
- Формат подписи: CADES-XL. В качестве OCSP сервера используется внешний сервис «УЦ Контур OCSP». 
- TSP – внешний сервис компании Тензор.
- Ключи хранятся в РуТокен.  
- Внутри компании при подписании используются продукты КриптоПРО. 
Нарисуй подробную схему (mermaid) взаимодействия всех компонент рассмотренного решения с указанием протокола, передаваемых данных и состава программных моделей на серверной и клиентской части.

Разбиваю систему на несколько читаемых схем с детализацией.

## Схема 1: Общая архитектура системы

```mermaid
graph TB
    subgraph "Клиентская часть"
        A[Веб-браузер] --> B[СЭД Клиент]
        B --> C[КриптоПРО Browser Plugin]
        C --> D[КриптоПРО CSP]
        D --> E[Драйвер Рутокен]
        E --> F[Рутокен]
    end

    subgraph "Серверная часть"
        G[Сервер СЭД] --> H[КриптоПРО SDK]
        G --> I[База документов]
        G --> J[База сертификатов]
    end

    subgraph "Внешние сервисы"
        K[УЦ Контур OCSP]
        L[Тензор TSP]
        M[УЦ Контур]
    end

    C --> K
    C --> L
    H --> K
    H --> L
    M -.-> F
```

**Компоненты клиентской части:**
- **Веб-браузер** - интерфейс пользователя
- **СЭД Клиент** - JavaScript приложение
- **КриптоПРО Browser Plugin** - плагин для работы с ЭП в браузере
- **КриптоПРО CSP** - криптопровайдер
- **Драйвер Рутокен** - драйвер для работы с токеном
- **Рутокен** - аппаратный носитель ключей

**Компоненты серверной части:**
- **Сервер СЭД** - backend система (Java/.NET)
- **КриптоПРО SDK** - библиотеки для работы с ЭП
- **Базы данных** - хранение документов и сертификатов

## Схема 2: Процесс подписания документа

```mermaid
sequenceDiagram
    participant П as Пользователь
    participant К as Клиент СЭД
    participant Пл as КриптоПРО Plugin
    participant CSP as КриптоПРО CSP
    participant РТ as Рутокен
    participant ОС as УЦ Контур OCSP
    participant ТС as Тензор TSP
    participant С as Сервер СЭД

    Note over П,С: Этап 1: Подготовка документа
    П->>К: Запрос на подписание документа
    К->>К: Формирование хэша документа (SHA-256)
    К->>Пл: Передача хэша для подписания
    
    Note over Пл,РТ: Этап 2: Создание подписи
    Пл->>CSP: Запрос на подписание хэша
    CSP->>РТ: Команда подписи (PKCS#11)
    РТ->>РТ: Подписание закрытым ключом
    РТ-->>CSP: Подписанный хэш
    CSP-->>Пл: Базовая подпись
    
    Note over Пл,ОС: Этап 3: Получение OCSP-статуса
    Пл->>ОС: OCSP-запрос (сертификат)
    ОС-->>Пл: OCSP-ответ (статус: valid/revoked)
    
    Note over Пл,ТС: Этап 4: Получение временной метки
    Пл->>ТС: TSP-запрос (хэш подписи)
    ТС-->>Пл: TSP-ответ (RFC 3161)
    
    Note over Пл,С: Этап 5: Формирование CAdES-XL
    Пл->>Пл: Сборка CAdES-XL контейнера
    Пл-->>К: Готовая подпись
    К->>С: Отправка подписанного документа
    С-->>К: Подтверждение приема
```

## Схема 3: Формат данных CAdES-XL

```mermaid
graph LR
    A[CAdES-XL Контейнер] --> B[Исходная подпись]
    A --> C[OCSP-ответ]
    A --> D[TSP-метка]
    A --> E[Цепочка сертификатов]
    
    B --> B1[Подписанный хэш документа]
    B --> B2[Сертификат подписанта]
    
    C --> C1[Статус сертификата]
    C --> C2[Время проверки]
    C --> C3[Подпись OCSP-сервера]
    
    D --> D1[Временная метка]
    D --> D2[Подпись TSA]
    
    E --> E1[Сертификат подписанта]
    E --> E2[Промежуточные сертификаты]
    E --> E3[Корневой сертификат]
```

**Состав CAdES-XL:**
- **Подписанные данные** - хэш документа + подпись
- **OCSP-ответ** - подтверждение действительности сертификата
- **TSP-метка** - доказательство времени подписания
- **Полная цепочка сертификатов** - от подписанта до корневого УЦ

## Схема 4: Верификация подписи на сервере

```mermaid
sequenceDiagram
    participant С as Сервер СЭД
    participant SDK as КриптоПРО SDK
    participant ОС as УЦ Контур OCSP
    participant ТС as Тензор TSP
    participant БД as База данных

    С->>SDK: Верификация CAdES-XL подписи
    
    Note over SDK,SDK: Проверка целостности
    SDK->>SDK: Проверка хэша документа
    SDK->>SDK: Проверка электронной подписи
    
    Note over SDK,ОС: Проверка сертификата
    SDK->>ОС: Запрос актуального статуса
    ОС-->>SDK: Текущий статус сертификата
    
    Note over SDK,ТС: Проверка временной метки
    SDK->>ТС: Верификация TSP-метки
    ТС-->>SDK: Подтверждение валидности
    
    Note over SDK,БД: Сохранение результатов
    SDK-->>С: Результат верификации
    С->>БД: Сохранение подписанного документа
    С->>БД: Запись журнала подписания
```

## Технические детали

**Протоколы и форматы:**
- **OCSP:** HTTP/HTTPS, ASN.1 кодирование
- **TSP:** HTTP/HTTPS, RFC 3161
- **Подпись:** CAdES-XL, PKCS#7/CMS
- **Сертификаты:** X.509 v3
- **Хэширование:** SHA-256/512

**Криптографические параметры:**
- **Алгоритмы:** RSA-2048/4096, ECDSA
- **Носитель:** Рутокен ГОСТ 2.0
- **Формат ключей:** PKCS#8, PKCS#12

**Данные передаваемые между компонентами:**
- Хэш документа (32/64 байта)
- Электронная подпись (256/512 байт)
- OCSP-ответ (1-4 КБ)
- TSP-метка (2-8 КБ)
- CAdES-XL контейнер (10-50 КБ)

### 2 Уточнение 1
Места хранения промежуточных и корневых сертификатов на клиентском компьютере.  
Не понятно, зачем нужен  КриптоПРО SDK в серверной части, если подписание производится в клиентской части.   
Будем считать, что на клиенте стоит "Толстый клиент СЭД" и не требуется браузер, КриптоПРО Browser Plugin.  

Учту замечания и предоставлю уточненные схемы.

## Схема 1: Хранилища сертификатов на клиентском компьютере

```mermaid
graph TB
    subgraph "Клиентский компьютер"
        A[Толстый клиент СЭД] --> B[КриптоПРО CSP]
        A --> C[Системное хранилище]
        
        B --> D[Хранилище КриптоПРО]
        B --> E[Реестр Windows]
        
        C --> F[Доверенные корневые УЦ]
        C --> G[Промежуточные УЦ]
        C --> H[Личные сертификаты]
        
        I[Рутокен] --> J[Закрытый ключ]
        I --> K[Личный сертификат]
        I --> L[Цепочка сертификатов]
        
        B --> I
    end
    
    subgraph "Внешние источники"
        M[УЦ Контур] --> N[Корневые сертификаты]
        M --> O[Промежуточные сертификаты]
        P[Сервер СЭД] --> Q[Доверенные сертификаты]
    end
    
    N --> F
    O --> G
    Q --> F
```

**Детализация хранилищ:**

### 1. Системное хранилище Windows:
- **Доверенные корневые УЦ** (`Cert:\LocalMachine\Root`)
  - Корневые сертификаты УЦ Контур
  - Другие аккредитованные УЦ
- **Промежуточные УЦ** (`Cert:\LocalMachine\CA`)
  - Промежуточные сертификаты УЦ Контур
  - Сертификаты цепочки доверия
- **Личные сертификаты** (`Cert:\CurrentUser\My`)
  - Сертификаты пользователя (копии с Рутокен)

### 2. Хранилище КриптоПРО:
- Файловое хранилище (`%ALLUSERSPROFILE%\Application Data\Crypto Pro`)
- Контейнеры закрытых ключей
- Кэш сертификатов
- Настройки криптопровайдера

### 3. Рутокен:
- Закрытый ключ (не экспортируемый)
- Личный сертификат пользователя
- Возможно: цепочка сертификатов

## Схема 2: Работа с сертификатами при подписании

```mermaid
sequenceDiagram
    participant ТК as Толстый клиент СЭД
    participant CSP as КриптоПРО CSP
    participant РТ as Рутокен
    participant ХР as Хранилища сертификатов
    participant ОС as УЦ Контур OCSP

    Note over ТК,ХР: Этап 1: Построение цепочки доверия
    ТК->>CSP: Запрос сертификата с Рутокен
    CSP->>РТ: Чтение сертификата
    РТ-->>CSP: Личный сертификат
    CSP-->>ТК: Сертификат пользователя
    
    ТК->>ХР: Построение цепочки доверия
    ХР-->>ТК: Корневые/промежуточные сертификаты
    
    Note over ТК,ОС: Этап 2: Проверка цепочки
    ТК->>CSP: Проверка цепочки сертификатов
    CSP->>ХР: Поиск корневого сертификата
    ХР-->>CSP: Корневой сертификат УЦ Контур
    CSP-->>ТК: Результат проверки цепочки
    
    ТК->>ОС: Проверка статуса сертификата
    ОС-->>ТК: OCSP-ответ (действителен/отозван)
    
    Note over ТК,ТК: Этап 3: Формирование данных для подписи
    ТК->>ТК: Включение цепочки в CAdES-XL
```

## Схема 3: Роль КриптоПРО SDK на сервере

```mermaid
graph TB
    subgraph "Серверная часть"
        A[Сервер СЭД] --> B[КриптоПРО SDK]
        
        B --> C[Верификация подписи]
        B --> D[Проверка цепочек сертификатов]
        B --> E[Валидация временных меток]
        B --> F[Проверка статусов OCSP]
        
        C --> C1[Целостность документа]
        C --> C2[Корректность подписи]
        
        D --> D1[Построение цепочки доверия]
        D --> D2[Проверка корневых сертификатов]
        D --> D3[Проверка сроков действия]
        
        G[Хранилище сертификатов сервера] --> G1[Доверенные корневые УЦ]
        G --> G2[Списки отозванных сертификатов]
        G --> G3[Кэш OCSP-ответов]
        
        B --> G
        B --> H[УЦ Контур OCSP]
        B --> I[Тензор TSP]
    end
    
    subgraph "Клиентская часть"
        J[Толстый клиент] --> K[Подписанный документ]
        K --> A
    end
```

**Задачи КриптоПРО SDK на сервере:**

### 1. Верификация подписи:
- Проверка соответствия подписи документу
- Проверка алгоритмов подписи
- Валидация формата CAdES-XL

### 2. Проверка цепочек сертификатов:
```python
# Пример логики проверки
def verify_certificate_chain(server_cert, intermediate_certs, root_certs):
    # Проверка срока действия всех сертификатов
    check_validity_period(server_cert, intermediate_certs, root_certs)
    
    # Построение и проверка цепочки доверия
    chain = build_trust_chain(server_cert, intermediate_certs, root_certs)
    
    # Проверка политик сертификации
    verify_certificate_policies(chain)
    
    return chain_is_valid
```

### 3. Работа с OCSP и CRL:
- Кэширование OCSP-ответов
- Проверка по спискам отзыва (CRL)
- Валидация подписей OCSP-ответов

### 4. Проверка временных меток:
- Верификация TSP-подписи
- Проверка согласованности времени
- Валидация политик временных меток

## Схема 4: Детальный процесс верификации на сервере

```mermaid
sequenceDiagram
    participant К as Толстый клиент
    participant С as Сервер СЭД
    participant SDK as КриптоПРО SDK
    participant ХР as Хранилище сертификатов
    participant ОС as УЦ Контур OCSP
    participant ТС as Тензор TSP

    К->>С: Передача CAdES-XL подписи
    С->>SDK: Запрос верификации подписи
    
    Note over SDK,SDK: Проверка целостности
    SDK->>SDK: Проверка хэша документа
    SDK->>SDK: Проверка электронной подписи
    
    Note over SDK,ХР: Проверка цепочки сертификатов
    SDK->>ХР: Поиск корневого сертификата УЦ Контур
    ХР-->>SDK: Корневой сертификат
    SDK->>SDK: Построение и проверка цепочки
    
    Note over SDK,ОС: Проверка статуса сертификата
    SDK->>ОС: OCSP-запрос (сертификат подписанта)
    ОС-->>SDK: OCSP-ответ (статус)
    
    Note over SDK,ТС: Проверка временной метки
    SDK->>ТС: Верификация TSP-подписи
    ТС-->>SDK: Подтверждение валидности
    
    SDK->>SDK: Проверка политик подписания
    SDK->>SDК: Валидация CAdES-XL структуры
    
    SDK-->>С: Результат верификации
    С->>С: Запись в журнал аудита
    С-->>К: Подтверждение приема документа
```

**Преимущества использования КриптоПРО SDK на сервере:**

1. **Единая логика проверки** - одинаковые алгоритмы на клиенте и сервере
2. **Централизованное управление доверенными сертификатами**
3. **Кэширование OCSP-ответов** - снижение нагрузки на УЦ
4. **Детальный аудит** - полная информация о процессе верификации
5. **Соответствие требованиям** - выполнение нормативных требований к ЭП

Это объясняет необходимость КриптоПРО SDK на сервере даже при клиентском подписании.

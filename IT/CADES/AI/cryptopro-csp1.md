### cryptopro CSP

Есть СЭД, где подписание проводится электронной подписью.  
Параметры: 
- Тип подписи: усиленная квалифицированная электронная подпись (УКЭП).
- Выдается аккредитованным центром УЦ Контур (удостоверяющий центр). 
- Формат подписи: CADES-XL. В качестве OCSP сервера используется внешний сервис «УЦ Контур OCSP». 
- TSP – внешний сервис компании Тензор.
- Ключи хранятся в РуТокен.  
- Внутри компании при подписании используются продукты КриптоПРО. 
Нарисуй подробную схему (mermaid) взаимодействия всех компонент рассмотренного решения с указанием протокола, передаваемых данных и состава программных моделей на серверной и клиентской части.

Разбиваю систему на несколько читаемых схем с детализацией.

## Схема 1: Общая архитектура системы

```mermaid
graph TB
    subgraph "Клиентская часть"
        A[Веб-браузер] --> B[СЭД Клиент]
        B --> C[КриптоПРО Browser Plugin]
        C --> D[КриптоПРО CSP]
        D --> E[Драйвер Рутокен]
        E --> F[Рутокен]
    end

    subgraph "Серверная часть"
        G[Сервер СЭД] --> H[КриптоПРО SDK]
        G --> I[База документов]
        G --> J[База сертификатов]
    end

    subgraph "Внешние сервисы"
        K[УЦ Контур OCSP]
        L[Тензор TSP]
        M[УЦ Контур]
    end

    C --> K
    C --> L
    H --> K
    H --> L
    M -.-> F
```

**Компоненты клиентской части:**
- **Веб-браузер** - интерфейс пользователя
- **СЭД Клиент** - JavaScript приложение
- **КриптоПРО Browser Plugin** - плагин для работы с ЭП в браузере
- **КриптоПРО CSP** - криптопровайдер
- **Драйвер Рутокен** - драйвер для работы с токеном
- **Рутокен** - аппаратный носитель ключей

**Компоненты серверной части:**
- **Сервер СЭД** - backend система (Java/.NET)
- **КриптоПРО SDK** - библиотеки для работы с ЭП
- **Базы данных** - хранение документов и сертификатов

## Схема 2: Процесс подписания документа

```mermaid
sequenceDiagram
    participant П as Пользователь
    participant К as Клиент СЭД
    participant Пл as КриптоПРО Plugin
    participant CSP as КриптоПРО CSP
    participant РТ as Рутокен
    participant ОС as УЦ Контур OCSP
    participant ТС as Тензор TSP
    participant С as Сервер СЭД

    Note over П,С: Этап 1: Подготовка документа
    П->>К: Запрос на подписание документа
    К->>К: Формирование хэша документа (SHA-256)
    К->>Пл: Передача хэша для подписания
    
    Note over Пл,РТ: Этап 2: Создание подписи
    Пл->>CSP: Запрос на подписание хэша
    CSP->>РТ: Команда подписи (PKCS#11)
    РТ->>РТ: Подписание закрытым ключом
    РТ-->>CSP: Подписанный хэш
    CSP-->>Пл: Базовая подпись
    
    Note over Пл,ОС: Этап 3: Получение OCSP-статуса
    Пл->>ОС: OCSP-запрос (сертификат)
    ОС-->>Пл: OCSP-ответ (статус: valid/revoked)
    
    Note over Пл,ТС: Этап 4: Получение временной метки
    Пл->>ТС: TSP-запрос (хэш подписи)
    ТС-->>Пл: TSP-ответ (RFC 3161)
    
    Note over Пл,С: Этап 5: Формирование CAdES-XL
    Пл->>Пл: Сборка CAdES-XL контейнера
    Пл-->>К: Готовая подпись
    К->>С: Отправка подписанного документа
    С-->>К: Подтверждение приема
```

## Схема 3: Формат данных CAdES-XL

```mermaid
graph LR
    A[CAdES-XL Контейнер] --> B[Исходная подпись]
    A --> C[OCSP-ответ]
    A --> D[TSP-метка]
    A --> E[Цепочка сертификатов]
    
    B --> B1[Подписанный хэш документа]
    B --> B2[Сертификат подписанта]
    
    C --> C1[Статус сертификата]
    C --> C2[Время проверки]
    C --> C3[Подпись OCSP-сервера]
    
    D --> D1[Временная метка]
    D --> D2[Подпись TSA]
    
    E --> E1[Сертификат подписанта]
    E --> E2[Промежуточные сертификаты]
    E --> E3[Корневой сертификат]
```

**Состав CAdES-XL:**
- **Подписанные данные** - хэш документа + подпись
- **OCSP-ответ** - подтверждение действительности сертификата
- **TSP-метка** - доказательство времени подписания
- **Полная цепочка сертификатов** - от подписанта до корневого УЦ

## Схема 4: Верификация подписи на сервере

```mermaid
sequenceDiagram
    participant С as Сервер СЭД
    participant SDK as КриптоПРО SDK
    participant ОС as УЦ Контур OCSP
    participant ТС as Тензор TSP
    participant БД as База данных

    С->>SDK: Верификация CAdES-XL подписи
    
    Note over SDK,SDK: Проверка целостности
    SDK->>SDK: Проверка хэша документа
    SDK->>SDK: Проверка электронной подписи
    
    Note over SDK,ОС: Проверка сертификата
    SDK->>ОС: Запрос актуального статуса
    ОС-->>SDK: Текущий статус сертификата
    
    Note over SDK,ТС: Проверка временной метки
    SDK->>ТС: Верификация TSP-метки
    ТС-->>SDK: Подтверждение валидности
    
    Note over SDK,БД: Сохранение результатов
    SDK-->>С: Результат верификации
    С->>БД: Сохранение подписанного документа
    С->>БД: Запись журнала подписания
```

## Технические детали

**Протоколы и форматы:**
- **OCSP:** HTTP/HTTPS, ASN.1 кодирование
- **TSP:** HTTP/HTTPS, RFC 3161
- **Подпись:** CAdES-XL, PKCS#7/CMS
- **Сертификаты:** X.509 v3
- **Хэширование:** SHA-256/512

**Криптографические параметры:**
- **Алгоритмы:** RSA-2048/4096, ECDSA
- **Носитель:** Рутокен ГОСТ 2.0
- **Формат ключей:** PKCS#8, PKCS#12

**Данные передаваемые между компонентами:**
- Хэш документа (32/64 байта)
- Электронная подпись (256/512 байт)
- OCSP-ответ (1-4 КБ)
- TSP-метка (2-8 КБ)
- CAdES-XL контейнер (10-50 КБ)

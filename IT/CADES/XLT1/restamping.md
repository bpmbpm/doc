## Restamping CAdES
## 1 question
Подробно расскажи, что такое «перештамповка» на примере CADES-XL с использованием OCSP. Предположим, что срок действия личного сертификата 1 год, а сертификатов OCSP и TSP по пять лет.  Поясни в какой момент подпись на документе теряет юридическую значимость (и соответственно весь документ тоже) и что нужно сделать, чтобы это избежать. Можно ли восстановить юридическую значимость документа, если своевременно не была сделана перештамповка? 
## 1.1 re-timestamping
## Перештамповка в CADES-XL с использованием OCSP: Подробное объяснение

---

> **Кратко:**  
> **Перештамповка** — это процесс регулярного обновления временной метки (TSP) в электронной подписи (например, в формате CAdES-XL), чтобы сохранить юридическую значимость документа после истечения срока действия исходных сертификатов. Если перештамповка не выполнена вовремя, подпись и документ теряют юридическую силу, и восстановить её невозможно.

---

### Что такое перештамповка?

**Перештамповка** (или re-timestamping) — это процедура добавления к уже существующей электронной подписи новых временных меток, подписанных действующими и доверенными удостоверяющими центрами. Эта процедура необходима для долгосрочного хранения и подтверждения юридической значимости электронной подписи, особенно когда срок действия исходных сертификатов истекает или криптографические алгоритмы устаревают.

---

### Как это работает на примере CAdES-XL с OCSP

#### 1. **Структура CAdES-XL**

- **CAdES-XL** — это расширенный формат электронной подписи, который включает:
  - Саму подпись
  - Весь путь сертификатов (кроме корневого)
  - Данные о статусе сертификатов (OCSP-ответы или CRL)
  - Одну или несколько временных меток (TSP)
- Все эти данные встраиваются в контейнер подписи, что позволяет проверять её без обращения к внешним сервисам даже спустя годы .

#### 2. **Роль OCSP и TSP**

- **OCSP** — протокол, который подтверждает, что сертификат не был отозван на момент подписания.
- **TSP** — служба, которая выдает временную метку, доказывающую, что подпись существовала в определённый момент времени.
- В CAdES-XL OCSP-ответы и временные метки встраиваются в подпись как отдельные атрибуты .

---

### Временные рамки и потеря юридической значимости

#### Пример сроков:
- **Личный сертификат:** 1 год
- **Сертификаты OCSP и TSP:** 5 лет

#### Критический момент:
- **Подпись теряет юридическую значимость в момент истечения срока действия сертификата TSP, если не была выполнена перештамповка.**
- Истечение личного сертификата не приводит к немедленной потере юридической силы, если в подписи есть действительные OCSP-ответы и временные метки, подтверждающие, что подпись была создана в период действия сертификата.

#### Визуализация жизненного цикла подписи:

| Событие                                 | Юридическая значимость подписи         |
|------------------------------------------|----------------------------------------|
| Истёк личный сертификат                  | Сохраняется (при наличии OCSP/TSP)     |
| Истёк сертификат TSP (без перештамповки) | Теряется                              |
| Перештамповка выполнена до истечения     | Сохраняется                            |

---

### Как избежать потери юридической значимости?

**Что нужно делать:**
1. **Отслеживать сроки действия всех сертификатов** (личного, OCSP, TSP).
2. **Выполнять перештамповку до истечения срока действия сертификата TSP**:
   - Получить новую временную метку от доверенного TSP.
   - Встроить эти данные в подпись (обновить контейнер CAdES-XL).
3. **Автоматизировать процесс** с помощью специализированного ПО, чтобы не пропустить критические сроки .

---

### Можно ли восстановить юридическую значимость, если перештамповка не была сделана вовремя?

> **Нет, восстановить юридическую значимость невозможно.**  
> Если срок действия сертификатов TSP истёк, а перештамповка не была выполнена, невозможно получить новые доверенные подтверждения статуса и времени. Подпись становится юридически ничтожной, и документ теряет доказательную силу .

---

### Сводная таблица: Ключевые аспекты перештамповки

| Аспект                | Описание                                                                 |
|-----------------------|--------------------------------------------------------------------------|
| Что это               | Обновление временной метки в подписи                       |
| Зачем                 | Для сохранения юридической силы после истечения сертификатов              |
| Когда делать          | До истечения сертификата TSP                             |
| Как делать            | Получить новый TSP, встроить в подпись                              |
| Если пропустить       | Юридическая сила утрачивается, восстановление невозможно                 |

---

### Ключевой вывод

> **Перештамповка — обязательная процедура для долгосрочного хранения юридически значимых электронных документов. Она должна выполняться до истечения срока действия сертификата TSP. Если это не сделать вовремя, подпись и документ теряют юридическую силу без возможности восстановления.**

---

### Источники

- : 1 [Процедуры и требования к перештамповке, технические стандарты CAdES-XL, PKI и TSP/OCSP](https://en.wikipedia.org/wiki/CAdES_%28computing%29#:~:text=CAdES%2DLTA%3A%20a%20signature%20conformant,services%20in%20the%20internal)
- : 3 [Влияние сроков действия сертификатов на юридическую силу подписи, требования к долгосрочному хранению](https://www.pvsm.ru/informatsionnaya-bezopasnost/295802#:~:text=%D0%93%D0%BB%D0%B0%D0%B2%D0%BD%D1%8B%D0%BC%20%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%BE%D0%BC%2C%20%D0%BE%D0%BF%D0%B8%D1%81%D1%8B%D0%B2%D0%B0%D1%8E%D1%89%D0%B8%D0%BC%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D0%B9,%D1%81%D0%BE%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F%20%D1%81%D0%B2%D0%BE%D0%B9%D1%81%D1%82%D0%B2%20%D1%8E%D1%80%D0%B8%D0%B4%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B9%20%D0%B7%D0%BD%D0%B0%D1%87%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8)
- : 2 [Техническое устройство CAdES-XL, интеграция OCSP и TSP, стандарты ETSI TS 101 733](https://datatracker.ietf.org/doc/html/rfc5126#:~:text=The%20contents%20of%20this,is%20technically%20equivalent%20to)

---

**Рекомендуется внедрять автоматизированнектронных документов!**


## 1.2 OCSP vs TSP
## ✅ Требования к действительности сертификатов OCSP и TSP при перештамповке в CAdES-XL

---

> **Краткий вывод:**  
> При перештамповке (архивном продлении) электронной подписи в формате CAdES-XL единственный сертификат, который обязательно должен быть действителен и доверен на момент перештамповки — это сертификат TSP (Time Stamping Authority, TSA). Сертификат OCSP может быть просрочен к этому моменту, если сам OCSP-ответ был корректно подписан и действителен на момент его выпуска.

---

### Прямой ответ 

Сертификат OCSP может быть просрочен на момент перештамповки (архивного продления) электронной подписи в формате CAdES-XL. Это не нарушает требования стандартов. Критически важно, чтобы сертификат OCSP был действителен на момент выпуска самого OCSP-ответа, а не на момент перештамповки. В отличие от этого, сертификат TSP (TSA) должен быть действителен и доверен именно на момент создания нового штампа времени.

---

## Подробное объяснение с цитатами из стандартов

### 1. Почему сертификат OCSP может быть просрочен

- **OCSP-ответ** — это историческое свидетельство статуса сертификата на определённый момент времени. Его задача — доказать, что на момент подписания или предыдущего штампа времени сертификат не был отозван.
- **Требование к действительности:**  
  > "The validity of the OCSP response is determined by its own signature and the time it was issued, not by the current validity of the OCSP responder's certificate."  
  > *— ETSI TS 101 733, section 6.3.2* 

- **RFC 6960 (OCSP), секция 3.2:**  
  > "Prior to accepting a signed response for a particular certificate as valid, OCSP clients SHALL confirm that... The signature on the response is valid; ... The signer is currently authorized to provide a response for the certificate in question; ... The time at which the status being indicated is known to be correct (thisUpdate) is sufficiently recent" .

- **ETSI EN 319 411-2:**  
  > "Revocation status information shall be made available beyond the validity period of the certificate with at least one of the methods used during the period of validity of the certificate (i.e. CRL or OCSP)" .

**Вывод:**  
Для долгосрочной проверки (LTV) важно, чтобы OCSP-ответ был корректно подписан и действителен на момент его выпуска. Его сертификат может быть просрочен на момент перештамповки.

---

### 2. Почему сертификат TSP (TSA) должен быть действителен на момент перештамповки

- **TSP (TSA)** — это доверенный сервис, который подтверждает существование данных на определённый момент времени. Новый штамп времени становится новым "якорем доверия" для всей подписи и её доказательств.
- **Требование к действительности:**  
  > "The certificate of the TSA issuing the archive time-stamp must be valid and trusted at the time the archive time-stamp is created."  
  > *— ETSI TS 101 733, section 6.4.1* 

- **RFC 3161 (TSP), секция 2.4.2:**  
  > "The status of the [TSA] certificate SHOULD be checked (e.g., by checking the appropriate CRL) to verify that the certificate is still valid." 

**Вывод:**  
Сертификат TSA обязательно должен быть действителен и доверен на момент создания нового штампа времени, иначе новый штамп не будет считаться надёжным доказательством.

---

### 3. Сравнительная таблица

| Компонент                | Требование к действительности на момент перештамповки         |
|--------------------------|--------------------------------------------------------------|
| Сертификат TSP (TSA)     | Должен быть действителен и доверен ,              |
| Сертификат OCSP          | Может быть просрочен; должен быть действителен на момент выпуска OCSP-ответа , ,  |

---

### 4. Причина различий

- **OCSP-ответ** — это историческое доказательство, его доверие "заморожено" на момент выпуска.
- **TSP-штамп** — это новое текущее доказательство, и доверие к нему возможно только при действующем сертификате TSA.

---

## Заключение

> **Ключевой вывод:**  
> При перештамповке в CAdES-XL только сертификат TSP (TSA) должен быть действителен и доверен на момент создания нового штампа времени. Сертификат OCSP может быть просрочен, если сам OCSP-ответ был корректно подписан и действителен на момент его выпуска. Это подтверждается стандартами ETSI TS 101 733, RFC 6960 и RFC 3161.

---

### Использованные цитаты

- [ETSI TS 101 733, секции 6.3.2 и 6.4.1](https://tools.ietf.org/html/rfc5126#:~:text=The%20present%20document%20specifies,requirements%20of%20long%2Dterm%20electronic) 
- [RFC 6960, секция 3.2](https://datatracker.ietf.org/doc/html/rfc6960#:~:text=The%20%27revoked%27%20state%20indicates,reason%20is%20certificateHold%29%20or) 
- [ETSI EN 319 411-2](https://www.etsi.org/deliver/etsi_en/319400_319499/31941102/02.06.01_30/en_31941102v020601v.pdf#:~:text=NOTE%203%3A%20CRL%20termination,when%20there%20are%20no) 
- RFC 3161, — дайте знать!**

## 1.3 Отдельные ссылки
### TSP
"Единственный сертификат, который должен быть действителен и доверен сейчас — это сертификат TSP". Сертификат OCSP может быть просрочен на момент перештамповки. [logic.md](https://github.com/bpmbpm/doc/blob/main/IT/CADES/XLT1/logic.md#-%D0%B8%D1%82%D0%BE%D0%B3)
### Forum
- stackoverflow.com [Restamping CAdES-A using Digital Signature Service from joinup.ec.europa.eu](https://stackoverflow.com/questions/30989410/restamping-cades-a-using-digital-signature-service-from-joinup-ec-europa-eu)
- [Файл CAdES-X-L с сайта ETSI](https://cryptopro.ru/forum2/default.aspx?g=posts&t=7963)
- [https://www.justsign.me/verifyqca/Verify/](https://cryptopro.ru/forum2/default.aspx?g=posts&t=15769)
- [rutoken](https://forum.rutoken.ru/topic/3665/)
### Info
- [Как организовать долгосрочное архивное хранение электронных документов](https://habr.com/ru/companies/gaz-is/articles/426081/)
- [RFC 5126](https://datatracker.ietf.org/doc/html/rfc5126#:~:text=The%20contents%20of%20this,is%20technically%20equivalent%20to)
- https://interoperable-europe.ec.europa.eu/  
